# Tempo Distributed Configuration for MicroK8s
fullnameOverride: tempo-distributed

# 1. Ingestion: Enable OTLP/HTTP and GRPC
distributor:
  replicas: 1
  config:
    log_received_traces: true
  
# 2. Storage: Use MinIO (S3 Compatible)
storage:
  trace:
    backend: s3
    s3:
      bucket: tempo-traces
      endpoint: minio.observability-prd.svc:9000
      access_key: admin
      secret_key: password123
      insecure: true
    wal:
      path: /var/tempo/wal

# 3. Components Configuration
ingester:
  replicas: 1
  persistence:
    enabled: true
    size: 10Gi
  config:
    replication_factor: 1 # Set to 1 for local lab (saves resources)

compactor:
  replicas: 1
  config:
    compaction:
      compaction_window: 1h
      max_block_bytes: 1073741824 # 1GB
      block_retention: 48h
      compacted_block_retention: 1h

querier:
  replicas: 1
  config:
    frontend_worker:
      frontend_address: tempo-distributed-query-frontend:9095

queryFrontend:
  replicas: 1

memcached:
  enabled: false # Disable caching for simple local setup

# 4. Global Overrides
global_overrides:
  per_tenant_override_config: /conf/overrides.yaml
  metrics_generator_processors: [service-graphs, span-metrics]

# 5. Gateway / Nginx (Optional but recommended for unifying access)
gateway:
  enabled: true
  replicas: 1
  ingress:
    enabled: false # We use port-forwarding instead

# 6. Service Graph Generation (Requires Metrics Generator)
metricsGenerator:
  enabled: true
  replicas: 1
  config:
    storage:
      remote_write:
        - url: http://mimir-distributed-distributor.observability-prd.svc:8080/api/v1/push
          send_exemplars: true
  
# 7. Tracing & Monitoring of Tempo itself
serviceMonitor:
  enabled: false # Set to true if you have Prometheus Operator installed