global:
  dnsService: "kube-dns"
  clusterDomain: "cluster.local"
  
  # -- GLOBAL SECRET INJECTION
  extraEnvFrom:
    - secretRef:
        name: mimir-s3-credentials

# ---------------------------------------------------------------------
# 1. MIMIR CONFIGURATION
# ---------------------------------------------------------------------
mimir:
  enabled: true
  fullnameOverride: mimir
  
  # -- USE ECR IMAGE (Bitnami)
  image:
    repository: public.ecr.aws/bitnami/grafana-mimir
    tag: latest
    pullPolicy: IfNotPresent

  multitenancy_enabled: true

  # Disable internal components
  minio: { enabled: false }
  kafka: { enabled: false }
  ingress: { enabled: false }

  # -- STRUCTURED CONFIGURATION --
  structuredConfig:
    # 1. Common Storage Configuration
    common:
      storage:
        backend: s3
        s3:
          endpoint: minio-storage.observability-prd.svc:9000
          bucket_name: mimir-blocks
          insecure: true
          # AWS_ACCESS_KEY_ID / AWS_SECRET_ACCESS_KEY injected via env

    # 2. Blocks Storage
    blocks_storage:
      backend: s3
      s3:
        bucket_name: mimir-blocks
      tsdb:
        dir: /data/tsdb

    # 3. Other Storage Components
    ruler_storage:
      backend: s3
      s3: { bucket_name: mimir-ruler }

    alertmanager_storage:
      backend: s3
      s3: { bucket_name: mimir-ruler }

    # 4. DISABLE USAGE STATS (Fixes the crash)
    usage_stats:
      enabled: false

  # -- DIET MODE & SCHEDULING --
  
  ingester:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }
    zoneAwareReplication: { enabled: false }
    affinity: null 

  distributor:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }
    affinity: null

  store_gateway:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }
    zoneAwareReplication: { enabled: false }
    affinity: null

  querier:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }
    affinity: null

  query_frontend:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }
    affinity: null

  ruler:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }
    affinity: null

  compactor:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }
    affinity: null

  alertmanager:
    replicas: 1
    resources: { requests: { memory: 32Mi, cpu: 10m } }
    zoneAwareReplication: { enabled: false }
    affinity: null

  overrides_exporter:
    replicas: 1
    resources: { requests: { memory: 64Mi, cpu: 10m } }

  rollout_operator: { enabled: false }
  chunks-cache: { enabled: false }
  index-cache: { enabled: false }
  results-cache: { enabled: false }
  metadata-cache: { enabled: false }

# ---------------------------------------------------------------------
# 2. TEMPO (Traces)
# ---------------------------------------------------------------------
tempo:
  enabled: true
  fullnameOverride: tempo
  minio: { enabled: false }
  ingress: { enabled: false }
  
  storage:
    trace:
      backend: s3
      s3:
        bucket: tempo-traces
        endpoint: minio-storage.observability-prd.svc:9000
        access_key: admin
        secret_key: "${s3_secret_key}"
        insecure: true

  distributor: { affinity: {}, replicas: 1 }
  ingester: { affinity: {}, replicas: 1 }
  compactor: { affinity: {} }
  querier: { affinity: {}, replicas: 1 }
  queryFrontend: { affinity: {} }
  gateway: { affinity: {} }
  metricsGenerator: { affinity: {} }

# ---------------------------------------------------------------------
# 3. LOKI (Logs)
# ---------------------------------------------------------------------
loki:
  enabled: true
  fullnameOverride: loki
  minio: { enabled: false }
  ingress: { enabled: false }
  
  loki:
    commonConfig:
      replication_factor: 1
    storage:
      type: filesystem
    structuredConfig:
      common:
        storage:
          s3:
            endpoint: minio-storage.observability-prd.svc:9000
            bucketnames: loki-data
            access_key_id: admin
            secret_access_key: "${s3_secret_key}"
            insecure: true
            s3forcepathstyle: true
      ruler:
        storage:
          s3:
            bucketnames: loki-ruler

  backend:
    replicas: 1
    resources: { requests: { memory: 128Mi }, limits: { memory: 512Mi } }
  read:
    replicas: 1
    resources: { requests: { memory: 128Mi }, limits: { memory: 512Mi } }
  write:
    replicas: 1
    resources: { requests: { memory: 128Mi }, limits: { memory: 512Mi } }

# ---------------------------------------------------------------------
# 4. GRAFANA ONCALL (DISABLED)
# ---------------------------------------------------------------------
grafana-oncall:
  enabled: false

# ---------------------------------------------------------------------
# 5. GRAFANA
# ---------------------------------------------------------------------
grafana:
  enabled: true
  admin: { existingSecret: "grafana-admin-creds", userKey: "admin-user", passwordKey: "admin-password" }
  ingress: { enabled: false }
  plugins: [] 
  
  grafana.ini:
    server:
      root_url: "%(protocol)s://%(domain)s:%(http_port)s/grafana/"
      serve_from_sub_path: true
  
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Mimir
          type: prometheus
          url: http://lgtm-distributed-mimir-query-frontend.observability-prd.svc:8080/prometheus
        - name: Tempo
          type: tempo
          url: http://lgtm-distributed-tempo-query-frontend.observability-prd.svc:3100
        - name: Loki
          type: loki
          url: http://lgtm-distributed-loki-query-frontend.observability-prd.svc:3100