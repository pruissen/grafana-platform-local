global:
  dnsService: "kube-dns"
  clusterDomain: "cluster.local"

# ---------------------------------------------------------------------
# 1. MIMIR (Metrics) - Fixed for Chart 5.8.0
# ---------------------------------------------------------------------
mimir:
  enabled: true
  fullnameOverride: mimir
  
  # -- Disable bundled services
  minio: { enabled: false }
  kafka: { enabled: false }
  ingress: { enabled: false }

  # -- Structured Config (Correct method for chart)
  structuredConfig:
    # 1. GLOBAL S3 CONFIGURATION
    common:
      storage:
        backend: s3
        s3:
          endpoint: minio-storage.observability-prd.svc:9000
          bucket_name: mimir-blocks
          access_key_id: admin
          secret_access_key: "${s3_secret_key}"
          insecure: true

    # 2. STORAGE DEFINITIONS
    # Explicitly defining backend ensures it inherits 'common' or uses the specific block
    blocks_storage:
      backend: s3
      s3:
        bucket_name: mimir-blocks
        endpoint: minio-storage.observability-prd.svc:9000
      tsdb:
        dir: /data/tsdb

    ruler_storage:
      backend: s3
      s3:
        bucket_name: mimir-ruler
        endpoint: minio-storage.observability-prd.svc:9000

    alertmanager_storage:
      backend: s3
      s3:
        bucket_name: mimir-ruler
        endpoint: minio-storage.observability-prd.svc:9000

    # Explicit duplication for usage_stats (Fixes the specific crash you saw)
    usage_stats:
      enabled: true
    
    usage_stats_storage:
      backend: s3
      s3:
        bucket_name: mimir-usage-stats
        endpoint: minio-storage.observability-prd.svc:9000
        access_key_id: admin
        secret_access_key: "${s3_secret_key}"
        insecure: true

    # 3. COMPONENT SETTINGS
    limits:
      max_cache_freshness: 10m
      max_query_parallelism: 240
      max_total_query_length: 12000h

    server:
      grpc_server_max_recv_msg_size: 104857600
      grpc_server_max_send_msg_size: 104857600

  # -- COMPONENTS (Diet Mode) --
  ingester:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }
    zoneAwareReplication: { enabled: false }

  distributor:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }

  store_gateway:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }
    zoneAwareReplication: { enabled: false }

  querier:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }

  query_frontend:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }

  query_scheduler:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }

  ruler:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }

  compactor:
    replicas: 1
    resources: { requests: { memory: 128Mi, cpu: 100m }, limits: { memory: 512Mi } }

  alertmanager:
    replicas: 1
    resources: { requests: { memory: 32Mi, cpu: 10m } }
    zoneAwareReplication: { enabled: false }

  overrides_exporter:
    replicas: 1
    resources: { requests: { memory: 64Mi, cpu: 10m } }

  # Disable heavy caches
  chunks-cache: { enabled: false }
  index-cache: { enabled: false }
  metadata-cache: { enabled: false }
  results-cache: { enabled: false }
  rollout_operator: { enabled: false }

# ---------------------------------------------------------------------
# 2. TEMPO (Traces)
# ---------------------------------------------------------------------
tempo:
  enabled: true
  fullnameOverride: tempo
  minio: { enabled: false }
  ingress: { enabled: false }
  
  storage:
    trace:
      backend: s3
      s3:
        bucket: tempo-traces
        endpoint: minio-storage.observability-prd.svc:9000
        access_key: admin
        secret_key: "${s3_secret_key}"
        insecure: true

  # Empty maps to silence affinity table warnings
  distributor: { affinity: {}, replicas: 1 }
  ingester: { affinity: {}, replicas: 1 }
  compactor: { affinity: {} }
  querier: { affinity: {}, replicas: 1 }
  queryFrontend: { affinity: {} }
  gateway: { affinity: {} }
  metricsGenerator: { affinity: {} }

# ---------------------------------------------------------------------
# 3. LOKI (Logs)
# ---------------------------------------------------------------------
loki:
  enabled: true
  fullnameOverride: loki
  minio: { enabled: false }
  ingress: { enabled: false }
  
  loki:
    commonConfig:
      replication_factor: 1
    storage:
      type: filesystem
    structuredConfig:
      common:
        storage:
          s3:
            endpoint: minio-storage.observability-prd.svc:9000
            bucketnames: loki-data
            access_key_id: admin
            secret_access_key: "${s3_secret_key}"
            insecure: true
            s3forcepathstyle: true
      ruler:
        storage:
          s3:
            bucketnames: loki-ruler

  backend:
    replicas: 1
    resources: { requests: { memory: 128Mi }, limits: { memory: 512Mi } }
  read:
    replicas: 1
    resources: { requests: { memory: 128Mi }, limits: { memory: 512Mi } }
  write:
    replicas: 1
    resources: { requests: { memory: 128Mi }, limits: { memory: 512Mi } }

# ---------------------------------------------------------------------
# 4. GRAFANA ONCALL (DISABLED)
# ---------------------------------------------------------------------
grafana-oncall:
  enabled: false

# ---------------------------------------------------------------------
# 5. GRAFANA
# ---------------------------------------------------------------------
grafana:
  enabled: true
  admin: { existingSecret: "grafana-admin-creds", userKey: "admin-user", passwordKey: "admin-password" }
  ingress: { enabled: false }
  plugins: [] 
  
  grafana.ini:
    server:
      root_url: "%(protocol)s://%(domain)s:%(http_port)s/grafana/"
      serve_from_sub_path: true
  
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Mimir
          type: prometheus
          url: http://lgtm-distributed-mimir-query-frontend.observability-prd.svc:8080/prometheus
        - name: Tempo
          type: tempo
          url: http://lgtm-distributed-tempo-query-frontend.observability-prd.svc:3100
        - name: Loki
          type: loki
          url: http://lgtm-distributed-loki-query-frontend.observability-prd.svc:3100