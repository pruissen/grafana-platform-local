# k8s/values/grafana.yaml

# 1. Admin Credentials (from Secret)
admin:
  existingSecret: "grafana-admin-creds"
  userKey: "admin-user"
  passwordKey: "admin-password"

# 2. Ingress & Service
ingress:
  enabled: false

service:
  type: ClusterIP
  port: 80

# 3. Persistence (Internal DB)
persistence:
  enabled: true
  storageClassName: local-path
  size: 10Gi

# 4. Data Sources (Automatic Integration)
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      # --- MIMIR (Metrics) ---
      - name: Prometheus (Mimir)
        type: prometheus
        uid: mimir
        url: http://mimir-nginx.observability-prd.svc:80/prometheus
        access: proxy
        isDefault: true
        jsonData:
          # Mimir often requires an Org ID header (default is anonymous/fake)
          httpHeaderName1: "X-Scope-OrgID"
        secureJsonData:
          httpHeaderValue1: "anonymous"

      # --- LOKI (Logs) ---
      - name: Loki
        type: loki
        uid: loki
        # Using the gateway/distributor service created by Loki Helm chart
        url: http://loki-gateway.observability-prd.svc:80
        access: proxy
        jsonData:
          derivedFields:
            # Correlate Logs -> Traces (Tempo)
            - datasourceUid: tempo
              matcherRegex: "traceID=(\\w+)"
              name: TraceID
              url: "$${__value.raw}"

      # --- TEMPO (Traces) ---
      - name: Tempo
        type: tempo
        uid: tempo
        url: http://tempo.observability-prd.svc:3100
        access: proxy
        jsonData:
          # Correlate Traces -> Logs (Loki)
          tracesToLogsV2:
            datasourceUid: loki
            spanStartTimeShift: "1h"
            tags: [{ key: "job" }, { key: "instance" }]
            filterByTraceID: false
            filterBySpanID: false
          # Correlate Traces -> Metrics (Mimir)
          tracesToMetrics:
            datasourceUid: mimir
            spanStartTimeShift: "1h"
            tags: [{ key: "service.name", value: "service" }, { key: "job" }]

      # --- ALERTMANAGER (Mimir) ---
      - name: Alertmanager
        type: alertmanager
        uid: alertmanager
        url: http://mimir-alertmanager.observability-prd.svc:8080
        access: proxy
        jsonData:
          implementation: prometheus

# 5. Dashboard Providers
# Automatically load dashboards from /var/lib/grafana/dashboards
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards

# 6. Enable Sidecar for Dashboards
# This allows you to deploy dashboards via ConfigMaps labeled 'grafana_dashboard'
sidecar:
  dashboards:
    enabled: true
    label: grafana_dashboard