# k8s/values/mimir.yaml
# Chart Version: 5.6.0

# üîí INJECT CREDENTIALS
# Injects AWS_ACCESS_KEY_ID & AWS_SECRET_ACCESS_KEY
global:
  extraEnvFrom:
    - secretRef:
        name: mimir-s3-credentials

mimir:
  image:
    repository: public.ecr.aws/bitnami/grafana-mimir
    tag: latest

  # üîí MULTI-TENANCY ENABLED
  auth_enabled: true

  structuredConfig:
    
    # Common Storage Configuration
    common:
      storage:
        backend: s3
        s3:
          endpoint: loki-minio.observability-prd.svc:9000
          bucket_name: mimir-blocks
          # ‚ö†Ô∏è REQUIRED: Force HTTP (MinIO does not have TLS)
          insecure: true

    # Blocks Storage (Long-term)
    blocks_storage:
      backend: s3
      s3:
        bucket_name: mimir-blocks
        endpoint: loki-minio.observability-prd.svc:9000
        insecure: true
      tsdb:
        dir: /data/tsdb

    # Ruler Storage (Alert Rules)
    ruler_storage:
      backend: s3
      s3:
        bucket_name: mimir-ruler
        endpoint: loki-minio.observability-prd.svc:9000
        insecure: true

    # Alertmanager Storage
    alertmanager_storage:
      backend: s3
      s3:
        bucket_name: mimir-ruler
        endpoint: loki-minio.observability-prd.svc:9000
        insecure: true
    
    usage_stats:
      enabled: false

    # --- REPLICATION FACTOR SETTINGS ---
    # Set to 1 because we are running single replicas per component
    ingester:
      ring:
        replication_factor: 1
    
    store_gateway:
      sharding_ring:
        replication_factor: 1

    distributor:
      ring:
        kvstore:
          store: memberlist

# --- COMPONENT SCALING ---
# Disable Mimir's own MinIO (We use Loki's)
minio:
  enabled: false

ingester:
  replicas: 1
  zoneAwareReplication: { enabled: false }
  affinity: null
  resources: { requests: { memory: 128Mi }, limits: { memory: 1Gi } }

store_gateway:
  replicas: 1
  zoneAwareReplication: { enabled: false }
  affinity: null
  resources: { requests: { memory: 128Mi }, limits: { memory: 1Gi } }

distributor: { replicas: 1, affinity: null }
querier: { replicas: 1, affinity: null }
query_frontend: { replicas: 1, affinity: null }
ruler: { replicas: 1, affinity: null }
compactor: { replicas: 1, affinity: null }
alertmanager: { replicas: 1, affinity: null, zoneAwareReplication: { enabled: false } }
overrides_exporter: { replicas: 1 }
rollout_operator: { enabled: true }
nginx: { enabled: true, replicas: 1 }