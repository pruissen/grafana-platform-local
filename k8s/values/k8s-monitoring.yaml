# yamllint disable rule:line-length rule:comments-indentation
---
cluster:
  name: "local-k3s"

#
# Global settings
#
global:
  scrapeInterval: 60s
  scrapeTimeout: 10s

# -----------------------------------------------------------------------
# ðŸ›‘ DISABLE OPENCOST
# -----------------------------------------------------------------------
opencost:
  enabled: false

metrics:
  cost:
    enabled: false

# -----------------------------------------------------------------------
# ðŸ”’ EXTERNAL SERVICES (Auth Enabled)
# -----------------------------------------------------------------------
externalServices:
  prometheus:
    host: "http://mimir-nginx.observability-prd.svc"
    port: 80
    writeEndpoint: "/api/v1/push"
    authMode: basic # <--- Re-enabled Auth
    secret:
      create: false # Terraform creates this
      name: "prometheus-k8s-monitoring" # Must match TF resource
      namespace: "observability-prd"

  loki:
    host: "http://loki-gateway.observability-prd.svc"
    port: 80
    writeEndpoint: "/loki/api/v1/push"
    authMode: basic # <--- Re-enabled Auth
    secret:
      create: false # Terraform creates this
      name: "loki-k8s-monitoring" # Must match TF resource
      namespace: "observability-prd"

  tempo:
    host: "tempo.observability-prd.svc"
    port: 4317
    authMode: basic # <--- Re-enabled Auth
    secret:
      create: false # Terraform creates this
      name: "tempo-k8s-monitoring" # Must match TF resource
      namespace: "observability-prd"

#
# Features
#
clusterMetrics:
  enabled: true
  collector: alloy-metrics

clusterEvents:
  enabled: true
  collector: alloy-metrics

nodeLogs:
  enabled: true
  collector: alloy-logs

podLogs:
  enabled: true
  collector: alloy-logs

podLogsViaKubernetesApi:
  enabled: false
  collector: alloy-logs

applicationObservability:
  enabled: true
  collector: alloy-receiver

autoInstrumentation:
  enabled: true
  collector: alloy-metrics

annotationAutodiscovery:
  enabled: true
  collector: alloy-metrics

prometheusOperatorObjects:
  enabled: true
  collector: alloy-metrics

profiling:
  enabled: true
  collector: alloy-profiles

integrations:
  destinations: []
  collector: alloy-metrics

selfReporting:
  enabled: false

#
# Collectors (Alloy instances)
#

# 1. ALLOY METRICS (Deployment)
alloy-metrics:
  enabled: true
  alloy:
    configMap:
      create: true
      content: |
        // --- 1. Sources ---
        discovery.kubernetes "k8s_services" { role = "service" }

        // Scrape Kube State Metrics
        discovery.relabel "ksm" {
          targets = discovery.kubernetes.k8s_services.targets
          rule { source_labels = ["__meta_kubernetes_service_label_app_kubernetes_io_name"]; regex = "kube-state-metrics"; action = "keep" }
        }
        prometheus.scrape "ksm" {
          targets = discovery.relabel.ksm.output
          forward_to = [prometheus.relabel.add_cluster.receiver]
        }

        // Cluster Events
        loki.source.kubernetes_events "events" {
          forward_to = [loki.process.add_cluster.receiver]
        }

        // --- 2. Processing ---
        prometheus.relabel "add_cluster" {
          forward_to = [prometheus.remote_write.platform_k8s.receiver]
          rule { action = "replace"; replacement = "local-k3s"; target_label = "cluster" }
        }
        
        loki.process "add_cluster" {
          forward_to = [loki.write.platform_k8s.receiver]
          stage.static_labels { values = { "cluster" = "local-k3s" } }
        }

        // --- 3. Routing/Output ---
        // Basic Auth is injected automatically by the Helm chart via `externalServices` config
        prometheus.remote_write "platform_k8s" {
          endpoint { 
            url = "http://mimir-nginx.observability-prd.svc:80/api/v1/push"
            headers = { "X-Scope-OrgID" = "platform-k8s" }
            // Auth block is dynamically generated by Helm here
          }
        }
        loki.write "platform_k8s" {
          endpoint { 
            url = "http://loki-gateway.observability-prd.svc:80/loki/api/v1/push" 
            tenant_id = "platform-k8s"
            // Auth block is dynamically generated by Helm here
          }
        }

# 2. ALLOY SINGLETON
alloy-singleton:
  enabled: false

# 3. ALLOY LOGS (DaemonSet)
alloy-logs:
  enabled: true
  alloy:
    configMap:
      create: true
      content: |
        // --- 1. Sources ---
        discovery.kubelet "local" {
          url = "https://localhost:10250"
          bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
          tls_config { insecure_skip_verify = true }
        }

        prometheus.exporter.unix "node" { include_exporter_metrics = true }
        prometheus.scrape "node" {
          targets = prometheus.exporter.unix.node.targets
          forward_to = [prometheus.relabel.add_cluster.receiver]
          job_name = "node-exporter"
        }

        prometheus.scrape "kubelet" {
          targets = discovery.kubelet.local.targets
          forward_to = [prometheus.relabel.add_cluster.receiver]
          job_name = "kubelet"
          scheme = "https"
          bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
          tls_config { insecure_skip_verify = true }
        }
        
        discovery.relabel "pod_logs" {
          targets = discovery.kubelet.local.targets
          rule { source_labels = ["__meta_kubernetes_namespace"]; target_label = "namespace" }
          rule { source_labels = ["__meta_kubernetes_pod_name"]; target_label = "pod" }
          rule { source_labels = ["__meta_kubernetes_pod_container_name"]; target_label = "container" }
          rule { source_labels = ["__meta_kubernetes_pod_label_app"]; target_label = "app" }
        }
        loki.source.kubernetes "pod_logs" {
          targets = discovery.relabel.pod_logs.output
          forward_to = [loki.process.add_cluster.receiver]
        }

        // --- 2. Processing ---
        prometheus.relabel "add_cluster" {
          forward_to = [prometheus.remote_write.platform_k8s.receiver, prometheus.remote_write.devteam_1.receiver]
          rule { action = "replace"; replacement = "local-k3s"; target_label = "cluster" }
        }

        loki.process "add_cluster" {
          forward_to = [loki.write.platform_k8s.receiver, loki.write.devteam_1.receiver]
          stage.static_labels { values = { "cluster" = "local-k3s" } }
        }

        // --- 3. Routing/Output ---
        prometheus.remote_write "platform_k8s" {
          endpoint { 
            url = "http://mimir-nginx.observability-prd.svc:80/api/v1/push"
            headers = { "X-Scope-OrgID" = "platform-k8s" }
          }
          write_relabel_config {
            source_labels = ["namespace"]
            regex = "argocd-system|kube-system|default|observability-prd|monitoring-system"
            action = "keep"
          }
        }
        loki.write "platform_k8s" {
          endpoint { 
            url = "http://loki-gateway.observability-prd.svc:80/loki/api/v1/push" 
            tenant_id = "platform-k8s"
          }
        }

        prometheus.remote_write "devteam_1" {
          endpoint { 
            url = "http://mimir-nginx.observability-prd.svc:80/api/v1/push"
            headers = { "X-Scope-OrgID" = "devteam-1" }
          }
          write_relabel_config {
            source_labels = ["namespace"]
            regex = "devteam-1"
            action = "keep"
          }
        }
        loki.write "devteam_1" {
          endpoint { 
            url = "http://loki-gateway.observability-prd.svc:80/loki/api/v1/push" 
            tenant_id = "devteam-1"
          }
        }

# 4. ALLOY RECEIVER
alloy-receiver:
  enabled: true
  
  extraService:
    enabled: true
    name: alloy
    fullname: ""

  alloy:
    extraPorts:
      - name: grpc
        port: 4317
        targetPort: 4317
        protocol: TCP
      - name: http
        port: 4318
        targetPort: 4318
        protocol: TCP
    
    configMap:
      create: true
      content: |
        // --- 1. Sources ---
        otelcol.receiver.otlp "default" {
          grpc { endpoint = "0.0.0.0:4317" }
          http { endpoint = "0.0.0.0:4318" }
          output {
            metrics = [otelcol.processor.batch.default.input]
            logs    = [otelcol.processor.batch.default.input]
            traces  = [otelcol.processor.batch.default.input]
          }
        }

        // --- 2. Processing ---
        otelcol.processor.batch "default" {
          output {
            metrics = [otelcol.processor.attributes.add_cluster.input]
            logs    = [otelcol.processor.attributes.add_cluster.input]
            traces  = [otelcol.processor.attributes.add_cluster.input]
          }
        }

        otelcol.processor.attributes "add_cluster" {
          action { key = "cluster" value = "local-k3s" action = "insert" }
          output {
            metrics = [otelcol.exporter.prometheus.platform.input, otelcol.exporter.prometheus.dev.input]
            logs    = [otelcol.exporter.loki.platform.input, otelcol.exporter.loki.dev.input]
            traces  = [otelcol.exporter.otlp.platform.input, otelcol.exporter.otlp.dev.input]
          }
        }

        // --- 3. Routing/Output ---
        otelcol.exporter.prometheus "platform" {
          forward_to = [prometheus.remote_write.platform.receiver]
        }
        prometheus.remote_write "platform" {
          endpoint { url = "http://mimir-nginx.observability-prd.svc:80/api/v1/push"; headers = { "X-Scope-OrgID" = "platform-k8s" } }
        }
        otelcol.exporter.loki "platform" {
          forward_to = [loki.write.platform.receiver]
        }
        loki.write "platform" {
          endpoint { url = "http://loki-gateway.observability-prd.svc:80/loki/api/v1/push"; tenant_id = "platform-k8s" }
        }
        otelcol.exporter.otlp "platform" {
          client {
            endpoint = "tempo.observability-prd.svc:4317"
            headers  = { "X-Scope-OrgID" = "platform-k8s" }
            tls { insecure = true }
          }
        }

        otelcol.exporter.prometheus "dev" {
          forward_to = [prometheus.remote_write.dev.receiver]
        }
        prometheus.remote_write "dev" {
          endpoint { url = "http://mimir-nginx.observability-prd.svc:80/api/v1/push"; headers = { "X-Scope-OrgID" = "devteam-1" } }
        }
        otelcol.exporter.loki "dev" {
          forward_to = [loki.write.dev.receiver]
        }
        loki.write "dev" {
          endpoint { url = "http://loki-gateway.observability-prd.svc:80/loki/api/v1/push"; tenant_id = "devteam-1" }
        }
        otelcol.exporter.otlp "dev" {
          client {
            endpoint = "tempo.observability-prd.svc:4317"
            headers  = { "X-Scope-OrgID" = "devteam-1" }
            tls { insecure = true }
          }
        }

alloy-profiles:
  enabled: true

collectorCommon:
  alloy: {}

alloy-operator:
  deploy: true
  waitForAlloyRemoval:
    enabled: true
    image:
      registry: ghcr.io
      repository: grafana/helm-chart-toolbox-kubectl
      tag: 0.1.2
      pullPolicy: IfNotPresent
    podAnnotations: {}
    podLabels:
      sidecar.istio.io/inject: "false"
      linkerd.io/inject: disabled
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 4242
      seccompProfile:
        type: RuntimeDefault
    resources: {}
    tolerations: []
    nodeSelector:
      kubernetes.io/os: linux

extraObjects: []