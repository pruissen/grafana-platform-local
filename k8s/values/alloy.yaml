# k8s/values/alloy.yaml
alloy:
  # ✅ CRITICAL: Expose OTLP ports so other apps can reach Alloy
  extraPorts:
    - name: otlp-grpc
      port: 4317
      targetPort: 4317
      protocol: TCP
    - name: otlp-http
      port: 4318
      targetPort: 4318
      protocol: TCP

  configMap:
    content: |
      otelcol.receiver.otlp "default" {
        grpc { endpoint = "0.0.0.0:4317" }
        http { endpoint = "0.0.0.0:4318" }
        output {
          metrics = [otelcol.processor.batch.default.input]
          logs    = [otelcol.processor.batch.default.input]
          traces  = [otelcol.processor.batch.default.input]
        }
      }

      otelcol.processor.batch "default" {
        output {
          metrics = [otelcol.exporter.prometheus.mimir.input]
          logs    = [otelcol.exporter.loki.default.input]
          traces  = [otelcol.exporter.otlp.tempo.input]
        }
      }

      otelcol.exporter.prometheus "mimir" {
        forward_to = [prometheus.remote_write.mimir.receiver]
      }
      prometheus.remote_write "mimir" {
        endpoint {
          url = "http://mimir-nginx.observability-prd.svc:80/api/v1/push"
          headers = { "X-Scope-OrgID" = "tenant1" }
        }
      }

      otelcol.exporter.loki "default" {
        forward_to = [loki.write.default.receiver]
      }
      loki.write "default" {
        endpoint {
          url = "http://loki-gateway.observability-prd.svc:80/loki/api/v1/push"
          tenant_id = "tenant1"
        }
      }

      otelcol.exporter.otlp "tempo" {
        client {
          // ✅ FIXED: Pointing to Monolithic 'tempo' service (not 'tempo-distributor')
          endpoint = "tempo.observability-prd.svc.cluster.local:4317"
          headers = { "X-Scope-OrgID" = "tenant1" }
          tls { insecure = true }
        }
      }

      prometheus.exporter.unix "default" { include_exporter_metrics = true }
      prometheus.scrape "node" {
        targets = prometheus.exporter.unix.default.targets
        forward_to = [prometheus.remote_write.mimir.receiver]
      }

  controller:
    type: DaemonSet
    resources: { requests: { cpu: 50m, memory: 128Mi }, limits: { memory: 512Mi } }