# k8s/values/alloy.yaml
alloy:
  configMap:
    create: true
    content: |
      
      // ==============================================================================
      // 1. SYSTEM PIPELINE (Tenant: platform-k8s)
      //    Scrapes K8s Nodes & Pod Logs -> Mimir/Loki
      // ==============================================================================

      // --- METRICS (Node Exporter) ---
      prometheus.exporter.unix "node_metrics" { }

      prometheus.scrape "node_scraper" {
        targets    = prometheus.exporter.unix.node_metrics.targets
        forward_to = [prometheus.remote_write.mimir_system.receiver]
      }

      // --- LOGS (Pod Logs) ---
      discovery.relabel "pod_logs" {
        targets = discovery.kubernetes.pods.targets
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          action = "keep"
          regex = "kube-system|observability-prd|argocd-system" // System namespaces
        }
      }

      discovery.kubernetes "pods" {
        role = "pod"
      }

      loki.source.kubernetes "pod_logs" {
        targets    = discovery.relabel.pod_logs.output
        forward_to = [loki.write.loki_system.receiver]
      }

      // --- SYSTEM EXPORTERS (Header: platform-k8s) ---
      prometheus.remote_write "mimir_system" {
        endpoint {
          url = "http://mimir-nginx.observability-prd.svc:80/api/v1/push"
          headers = {
            "X-Scope-OrgID" = "platform-k8s",
          }
        }
      }

      loki.write "loki_system" {
        endpoint {
          url = "http://loki-gateway.observability-prd.svc:80/loki/api/v1/push"
          headers = {
            "X-Scope-OrgID" = "platform-k8s",
          }
        }
      }

      // ==============================================================================
      // 2. SHOP PIPELINE (Tenant: devteam-1)
      //    Receives OTLP Traces/Metrics/Logs -> Mimir/Loki/Tempo
      // ==============================================================================

      // --- RECEIVER (OTLP) ---
      otelcol.receiver.otlp "shop_receiver" {
        grpc { endpoint = "0.0.0.0:4317" }
        http { endpoint = "0.0.0.0:4318" }

        output {
          metrics = [otelcol.processor.batch.shop_batch.input]
          logs    = [otelcol.processor.batch.shop_batch.input]
          traces  = [otelcol.processor.batch.shop_batch.input]
        }
      }

      // --- PROCESSOR ---
      otelcol.processor.batch "shop_batch" {
        output {
          metrics = [otelcol.exporter.prometheus.mimir_shop_converter.input]
          logs    = [otelcol.exporter.loki.loki_shop.input]
          traces  = [otelcol.exporter.otlp.tempo_shop.input]
        }
      }

      // --- SHOP EXPORTERS (Header: devteam-1) ---

      // 1. Traces -> Tempo
      otelcol.exporter.otlp "tempo_shop" {
        client {
          endpoint = "tempo.observability-prd.svc:4317"
          tls {
            insecure = true
          }
          headers = {
            "X-Scope-OrgID" = "devteam-1",
          }
        }
      }

      // 2. Logs -> Loki
      otelcol.exporter.loki "loki_shop" {
        forward_to = [loki.write.loki_shop_client.receiver]
      }
      
      loki.write "loki_shop_client" {
        endpoint {
          url = "http://loki-gateway.observability-prd.svc:80/loki/api/v1/push"
          headers = {
            "X-Scope-OrgID" = "devteam-1",
          }
        }
      }

      // 3. Metrics -> Mimir (OTLP to Prometheus conversion)
      otelcol.exporter.prometheus "mimir_shop_converter" {
        forward_to = [prometheus.remote_write.mimir_shop.receiver]
      }

      prometheus.remote_write "mimir_shop" {
        endpoint {
          url = "http://mimir-nginx.observability-prd.svc:80/api/v1/push"
          headers = {
            "X-Scope-OrgID" = "devteam-1",
          }
        }
      }

# Enable the controller
controller:
  type: daemonset

service:
  enabled: true
  type: ClusterIP
  ports:
    otlp-grpc: { port: 4317, targetPort: 4317, protocol: TCP }
    otlp-http: { port: 4318, targetPort: 4318, protocol: TCP }